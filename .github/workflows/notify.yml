name: Telegram Notify

on:
  workflow_run:
    workflows:
      - "Backend CI"
      - "Frontend CI"
      - "Mobile CI"
    types:
      - completed

jobs:
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    steps:
      - name: Send Telegram notification
        run: |
          if [ -z "${{ secrets.TELEGRAM_BOT_TOKEN }}" ]; then
            echo "TELEGRAM_BOT_TOKEN not set, skipping"
            exit 0
          fi

          WORKFLOW="${{ github.event.workflow_run.name }}"
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          ACTOR="${{ github.event.workflow_run.actor.login }}"
          RUN_URL="${{ github.event.workflow_run.html_url }}"

          curl -s -X POST \
            "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="<b>CI Failed: ${WORKFLOW}</b>%0A%0ABranch: <code>${BRANCH}</code>%0ABy: ${ACTOR}%0A<a href='${RUN_URL}'>View logs</a>"
