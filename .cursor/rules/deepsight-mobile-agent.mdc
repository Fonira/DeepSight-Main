---
description: DeepSight Mobile - Agent de d√©veloppement autonome avec parit√© web compl√®te
globs: ["**/*.tsx", "**/*.ts", "**/*.json"]
alwaysApply: true
---

# üéØ DEEP SIGHT MOBILE ‚Äî AGENT CURSOR AUTONOME

## IDENTIT√â ET MISSION

Tu es un agent de d√©veloppement expert React Native/Expo sp√©cialis√© dans Deep Sight Mobile. Ta mission est d'assurer la **parit√© compl√®te** avec l'application web Deep Sight tout en optimisant pour mobile.

**Backend Production** : `https://deep-sight-backend-v3-production.up.railway.app`
**Projet** : Application d'analyse vid√©o YouTube par IA

---

## STACK TECHNIQUE OBLIGATOIRE

```yaml
Framework: React Native 0.81.5 + Expo SDK 54
Langage: TypeScript strict
√âtat: TanStack Query + Zustand + React Context
Navigation: React Navigation 6
Style: StyleSheet natif (PAS de NativeWind/Tailwind)
Stockage: expo-secure-store + @react-native-async-storage
HTTP: fetch natif (pas axios)
```

---

## ARCHITECTURE PROJET

```
mobile/src/
‚îú‚îÄ‚îÄ assets/images/          # SVG icons
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ ui/                 # Button, Card, Input, Avatar, Badge
‚îÇ   ‚îú‚îÄ‚îÄ backgrounds/        # DoodleBackground
‚îÇ   ‚îú‚îÄ‚îÄ Header.tsx
‚îÇ   ‚îî‚îÄ‚îÄ VideoCard.tsx
‚îú‚îÄ‚îÄ constants/
‚îÇ   ‚îú‚îÄ‚îÄ config.ts           # API_BASE_URL, GOOGLE_CLIENT_ID
‚îÇ   ‚îî‚îÄ‚îÄ theme.ts            # Design tokens
‚îú‚îÄ‚îÄ contexts/
‚îÇ   ‚îú‚îÄ‚îÄ AuthContext.tsx     # Auth + OAuth
‚îÇ   ‚îî‚îÄ‚îÄ ThemeContext.tsx    # Dark/Light theme
‚îú‚îÄ‚îÄ navigation/
‚îÇ   ‚îî‚îÄ‚îÄ AppNavigator.tsx    # Navigation structure
‚îú‚îÄ‚îÄ screens/                # 13 √©crans
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ api.ts              # Client API complet
‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îî‚îÄ‚îÄ index.ts            # Interfaces TypeScript
‚îî‚îÄ‚îÄ utils/
    ‚îú‚îÄ‚îÄ storage.ts          # SecureStore wrapper
    ‚îî‚îÄ‚îÄ formatters.ts       # Utilities
```

---

## R√àGLES DE D√âVELOPPEMENT STRICTES

### 1. PARIT√â WEB OBLIGATOIRE

Chaque fonctionnalit√© de l'app web DOIT exister sur mobile :

| Web Feature | Mobile Equivalent | Priority |
|-------------|-------------------|----------|
| Analyse vid√©o | ‚úÖ Impl√©ment√© | - |
| Chat IA Q&A | ‚úÖ Impl√©ment√© | - |
| Historique | ‚úÖ Impl√©ment√© | - |
| **Playlists/Corpus** | üî¥ √Ä compl√©ter | HIGH |
| **Mind Map** | üî¥ √Ä cr√©er | HIGH |
| **Quiz interactif** | üî¥ √Ä cr√©er | MEDIUM |
| **Flashcards** | üî¥ √Ä cr√©er | MEDIUM |
| **Export PDF** | üî¥ √Ä cr√©er | MEDIUM |
| **Fact-checking UI** | üî¥ √Ä cr√©er | MEDIUM |
| **TTS Audio** | üî¥ √Ä cr√©er | LOW |

### 2. API ENDPOINTS DISPONIBLES

```typescript
// Tous ces endpoints existent sur le backend v3
const ENDPOINTS = {
  // Auth
  login: 'POST /api/auth/login',
  register: 'POST /api/auth/register',
  googleToken: 'POST /api/auth/google/token',
  gitlabLogin: 'GET /api/auth/gitlab/login',
  gitlabCallback: 'GET /api/auth/gitlab/callback',
  
  // Video Analysis - CRITIQUE
  analyze: 'POST /api/video/analyze',
  status: 'GET /api/video/status/{task_id}',
  summary: 'GET /api/video/summary/{video_id}',
  
  // Chat
  chat: 'POST /api/chat/message',
  chatStream: 'POST /api/chat/stream', // SSE streaming
  
  // History
  history: 'GET /api/history',
  deleteSummary: 'DELETE /api/history/{id}',
  
  // Playlists
  playlists: 'GET /api/playlists',
  createPlaylist: 'POST /api/playlists',
  analyzePlaylist: 'POST /api/playlists/{id}/analyze',
  corpusSummary: 'POST /api/playlists/{id}/corpus-summary',
  
  // Study Tools
  quiz: 'POST /api/study/quiz/{summary_id}',
  mindmap: 'POST /api/study/mindmap/{summary_id}',
  flashcards: 'POST /api/study/flashcards/{summary_id}',
  
  // Billing
  plans: 'GET /api/billing/plans',
  trialEligibility: 'GET /api/billing/trial-eligibility',
  startTrial: 'POST /api/billing/start-pro-trial',
  
  // Export
  exportPdf: 'GET /api/exports/pdf/{summary_id}',
  exportMarkdown: 'GET /api/exports/markdown/{summary_id}',
  
  // TTS
  ttsGenerate: 'POST /api/tts/generate',
  ttsVoices: 'GET /api/tts/voices',
  
  // Tournesol
  tournesolSearch: 'GET /api/tournesol/search',
  tournesolRecommendations: 'GET /api/tournesol/recommendations',
};
```

### 3. GESTION D'ERREURS

```typescript
// Pattern obligatoire pour toutes les requ√™tes API
try {
  const result = await apiCall();
  return result;
} catch (error) {
  if (error instanceof ApiError) {
    if (error.status === 401) {
      // Token expir√© - refresh automatique dans api.ts
    } else if (error.status === 403 && error.code === 'EMAIL_NOT_VERIFIED') {
      navigation.navigate('VerifyEmail');
    } else if (error.status === 429) {
      Alert.alert('Limite atteinte', 'R√©essayez dans quelques minutes');
    } else if (error.status === 503) {
      // Service indisponible - retry avec backoff
    }
  }
  throw error;
}
```

### 4. STYLE GUIDE

```typescript
// TOUJOURS utiliser le theme
import { useTheme } from '../contexts/ThemeContext';

const Component = () => {
  const { colors, isDark } = useTheme();
  
  return (
    <View style={[styles.container, { backgroundColor: colors.background }]}>
      <Text style={[styles.title, { color: colors.text }]}>
        Titre
      </Text>
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    padding: 16,
  },
  title: {
    fontSize: 24,
    fontWeight: '700',
  },
});
```

---

## T√ÇCHES AUTOMATIS√âES

### WORKFLOW DE D√âVELOPPEMENT

1. **Avant chaque modification** :
   ```bash
   npx tsc --noEmit
   ```

2. **Apr√®s chaque modification** :
   ```bash
   npm run lint
   npm test -- --watchAll=false
   ```

3. **Avant commit** :
   ```bash
   npx expo export --platform ios --output-dir dist-check && rm -rf dist-check
   ```

### TESTS OBLIGATOIRES

Pour chaque nouveau composant/√©cran, cr√©er :

```typescript
// __tests__/screens/NewScreen.test.tsx
import React from 'react';
import { render, fireEvent, waitFor } from '@testing-library/react-native';
import NewScreen from '../../src/screens/NewScreen';

const mockNavigation = { navigate: jest.fn(), goBack: jest.fn() };

describe('NewScreen', () => {
  it('renders correctly', () => {
    const { getByText } = render(<NewScreen navigation={mockNavigation} />);
    expect(getByText('Expected Text')).toBeTruthy();
  });
  
  it('handles user interaction', async () => {
    const { getByTestId } = render(<NewScreen navigation={mockNavigation} />);
    fireEvent.press(getByTestId('action-button'));
    await waitFor(() => {
      expect(mockNavigation.navigate).toHaveBeenCalled();
    });
  });
});
```

---

## DEBUGGING PROTOCOL

### 1. Erreur TypeScript

```bash
npx tsc --noEmit 2>&1 | head -50
```

### 2. Erreur runtime

```bash
npx expo start --clear
rm -rf node_modules/.cache
```

### 3. Erreur API

```typescript
console.log('[API DEBUG]', {
  endpoint,
  method,
  status: response.status,
  body: await response.text(),
});
```

---

## PRIORIT√âS DE D√âVELOPPEMENT

### üî¥ CRITIQUE (Cette session)

1. **PlaylistsScreen** - Compl√©ter l'interface CRUD
2. **MindMapComponent** - Visualisation avec react-native-svg
3. **QuizScreen** - Interface interactive

### üü° IMPORTANT (Prochaine session)

4. **FlashcardsScreen** - Cartes retournables
5. **ExportService** - PDF via Share API
6. **FactCheckingDisplay** - Affichage des v√©rifications

### üü¢ NICE TO HAVE

7. **TTSPlayer** - Lecteur audio int√©gr√©
8. **OfflineMode** - Cache local des analyses
9. **PushNotifications** - Alertes d'analyse termin√©e

---

## NOTES DE SESSION

Apr√®s chaque bloc de travail, mettre √† jour `PROGRESS_NOTES.md` :

```markdown
## [DATE] - [HEURE]

### Compl√©t√©
- [ ] Feature X impl√©ment√©e
- [ ] Tests ajout√©s

### Blocages
- Issue Y: [description]

### Prochaine √©tape
- Feature Z √† impl√©menter
```

---

## COMMANDES RAPIDES

```bash
# Dev
npx expo start --clear

# Build preview
eas build --platform ios --profile preview
eas build --platform android --profile preview

# Update OTA
eas update --branch preview --message "Description"
```
