(()=>{"use strict";function e(e){const t=[/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&?\s]+)/,/youtube\.com\/shorts\/([^&?\s]+)/];for(const n of t){const t=e.match(n);if(t)return t[1]}return null}let t=null,n=!1,s=null,i=null,o=0;const d=["#top-level-buttons-computed","ytd-watch-metadata #actions #top-level-buttons-computed","#actions ytd-menu-renderer","ytd-watch-metadata #actions","#menu-container","#info #menu-container","ytd-video-primary-info-renderer #menu-container","#info-contents #menu-container","#actions-inner","#actions","ytd-watch-metadata ytd-menu-renderer",".ytp-right-controls"];function a(){const e=document.documentElement;return"true"===e.getAttribute("dark")||e.hasAttribute("dark")||document.body.classList.contains("dark")||getComputedStyle(document.body).backgroundColor.includes("rgb(15,")||getComputedStyle(e).getPropertyValue("--yt-spec-base-background").includes("#0f")}async function r(){if(!s)return;if(s.classList.toggle("open"),!s.classList.contains("open"))return;const e=document.getElementById("deepsight-content");if(e){e.innerHTML='\n    <div class="deepsight-loading">\n      <div class="deepsight-spinner"></div>\n      <p>Checking authentication...</p>\n    </div>\n  ';try{const t=await chrome.runtime.sendMessage({action:"CHECK_AUTH"});if(!t.authenticated)return e.innerHTML='\n    <div class="deepsight-auth">\n      <div class="deepsight-auth-icon">ğŸ”</div>\n      <h3>Sign in to DeepSight</h3>\n      <p>Analyze this video with AI-powered insights</p>\n      <button class="deepsight-btn-primary" id="deepsight-login">\n        Sign in to DeepSight\n      </button>\n      <p class="deepsight-auth-note">\n        Don\'t have an account? \n        <a href="https://deepsight.vercel.app/register" target="_blank">Sign up free</a>\n      </p>\n    </div>\n  ',void document.getElementById("deepsight-login")?.addEventListener("click",()=>{chrome.runtime.sendMessage({action:"OPEN_POPUP"}),window.open("https://deepsight.vercel.app/login?extension=true","_blank","width=500,height=600")});!function(e,t){const n=window.location.href;e.innerHTML=`\n    <div class="deepsight-analysis-ui">\n      <div class="deepsight-user-info">\n        <span class="deepsight-credits">${t.credits} credits</span>\n        <span class="deepsight-plan">${t.plan}</span>\n      </div>\n      \n      <div class="deepsight-options">\n        <label class="deepsight-option">\n          <span>Analysis Mode</span>\n          <select id="deepsight-mode">\n            <option value="accessible">ğŸ“– Accessible</option>\n            <option value="standard" selected>ğŸ“‹ Standard</option>\n            <option value="expert">ğŸ“ Expert</option>\n          </select>\n        </label>\n        \n        <label class="deepsight-option">\n          <span>Language</span>\n          <select id="deepsight-lang">\n            <option value="fr">ğŸ‡«ğŸ‡· French</option>\n            <option value="en">ğŸ‡¬ğŸ‡§ English</option>\n            <option value="es">ğŸ‡ªğŸ‡¸ Spanish</option>\n            <option value="de">ğŸ‡©ğŸ‡ª German</option>\n          </select>\n        </label>\n      </div>\n      \n      <button class="deepsight-btn-primary deepsight-btn-full" id="deepsight-start">\n        ğŸš€ Analyze Video\n      </button>\n      \n      <div id="deepsight-result" class="deepsight-result hidden"></div>\n    </div>\n  `,document.getElementById("deepsight-start")?.addEventListener("click",async()=>{const e=document.getElementById("deepsight-mode").value,t=document.getElementById("deepsight-lang").value;await async function(e,t){const n=document.getElementById("deepsight-result"),s=document.getElementById("deepsight-start");if(n&&s){s.disabled=!0,s.innerHTML='<div class="deepsight-spinner-small"></div> Analyzing...',n.classList.remove("hidden"),n.innerHTML='\n    <div class="deepsight-progress">\n      <div class="deepsight-progress-bar" id="deepsight-progress-bar" style="width: 0%"></div>\n    </div>\n    <p class="deepsight-progress-text" id="deepsight-progress-text">Starting analysis...</p>\n  ';try{const n=await chrome.runtime.sendMessage({action:"ANALYZE_VIDEO",data:{url:e,options:t}});if(!n.success)throw new Error(n.error);const s=n.result;if("completed"===s.status&&s.result?.summary_id)!async function(e){const t=document.getElementById("deepsight-result"),n=document.getElementById("deepsight-start");var s,i;if(t&&n)try{const o=await chrome.runtime.sendMessage({action:"GET_SUMMARY",data:{summaryId:e}});if(!o.success)throw new Error(o.error);const d=o.summary,a=/\[(\d{1,2}:\d{2}(?::\d{2})?)\]/g;let c=d.summary_content;c=c.replace(a,(e,t)=>{const n=function(e){const t=e.split(":").map(Number);return 3===t.length?3600*t[0]+60*t[1]+t[2]:60*t[0]+t[1]}(t);return`<a href="#" class="deepsight-timestamp" data-time="${n}">[${t}]</a>`}),t.innerHTML=`\n      <div class="deepsight-summary">\n        <div class="deepsight-summary-header">\n          <h3>âœ… Analysis Complete</h3>\n          <div class="deepsight-summary-meta">\n            <span class="deepsight-category">${i=d.category,{tech:"ğŸ’»",science:"ğŸ”¬",education:"ğŸ“š",news:"ğŸ“°",entertainment:"ğŸ¬",gaming:"ğŸ®",music:"ğŸµ",sports:"âš½",business:"ğŸ’¼",lifestyle:"ğŸŒŸ",other:"ğŸ“‹"}[i]||"ğŸ“‹"} ${d.category}</span>\n            <span class="deepsight-reliability" title="Reliability Score">\n              ${s=d.reliability_score,s>=80?"âœ…":s>=60?"âš ï¸":"â“"} ${d.reliability_score}%\n            </span>\n          </div>\n        </div>\n        \n        <div class="deepsight-summary-content">\n          ${c}\n        </div>\n        \n        <div class="deepsight-summary-actions">\n          <button class="deepsight-btn-secondary" id="deepsight-chat">\n            ğŸ’¬ Chat with video\n          </button>\n          <a href="https://deepsight.vercel.app/summary/${e}" \n             target="_blank" \n             class="deepsight-btn-secondary">\n            ğŸ“– Full view\n          </a>\n        </div>\n      </div>\n    `,t.querySelectorAll(".deepsight-timestamp").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),function(e){const t=document.querySelector("video");t&&(t.currentTime=e,t.play())}(parseInt(e.dataset.time||"0"))})}),document.getElementById("deepsight-chat")?.addEventListener("click",()=>{!function(e,t){const n=document.getElementById("deepsight-content");n&&(n.innerHTML=`\n    <div class="deepsight-chat">\n      <div class="deepsight-chat-header">\n        <button class="deepsight-back" id="deepsight-back">â† Back</button>\n        <h3>Chat with "${t.substring(0,30)}..."</h3>\n      </div>\n      \n      <div class="deepsight-chat-messages" id="deepsight-messages">\n        <div class="deepsight-chat-message assistant">\n          <p>ğŸ‘‹ Hi! Ask me anything about this video.</p>\n        </div>\n      </div>\n      \n      <form class="deepsight-chat-input" id="deepsight-chat-form">\n        <input type="text" \n               id="deepsight-question" \n               placeholder="Ask a question..."\n               autocomplete="off" />\n        <button type="submit" class="deepsight-btn-primary">Send</button>\n      </form>\n    </div>\n  `,document.getElementById("deepsight-back")?.addEventListener("click",()=>{r()}),document.getElementById("deepsight-chat-form")?.addEventListener("submit",async t=>{t.preventDefault();const n=document.getElementById("deepsight-question"),s=n.value.trim();s&&(n.value="",await async function(e,t){const n=document.getElementById("deepsight-messages");if(n){n.innerHTML+=`\n    <div class="deepsight-chat-message user">\n      <p>${function(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}(t)}</p>\n    </div>\n  `,n.innerHTML+='\n    <div class="deepsight-chat-message assistant loading" id="deepsight-loading">\n      <div class="deepsight-spinner-small"></div>\n    </div>\n  ',n.scrollTop=n.scrollHeight;try{const i=await chrome.runtime.sendMessage({action:"ASK_QUESTION",data:{summaryId:e,question:t}});if(document.getElementById("deepsight-loading")?.remove(),!i.success)throw new Error(i.error);n.innerHTML+=`\n      <div class="deepsight-chat-message assistant">\n        <p>${s=i.result.response,s.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/\n/g,"<br>")}</p>\n        ${i.result.web_search_used?'<span class="deepsight-web-badge">ğŸŒ Web enriched</span>':""}\n      </div>\n    `,n.scrollTop=n.scrollHeight}catch(e){document.getElementById("deepsight-loading")?.remove(),n.innerHTML+=`\n      <div class="deepsight-chat-message error">\n        <p>âŒ ${e.message}</p>\n      </div>\n    `}var s}}(e,s))}))}(e,d.video_title)}),n.disabled=!1,n.innerHTML="ğŸ”„ Re-analyze"}catch(e){t.innerHTML=`\n      <div class="deepsight-error">\n        <p>âŒ Failed to load summary: ${e.message}</p>\n      </div>\n    `,n.disabled=!1,n.innerHTML="ğŸš€ Analyze Video"}}(s.result.summary_id);else if("failed"===s.status)throw new Error(s.error||"Analysis failed")}catch(e){n.innerHTML=`\n      <div class="deepsight-error">\n        <p>âŒ ${e.message}</p>\n        <button class="deepsight-btn-secondary" onclick="document.getElementById('deepsight-start').click()">\n          Retry\n        </button>\n      </div>\n    `,s.disabled=!1,s.innerHTML="ğŸš€ Analyze Video"}}}(n,{mode:e,lang:t})})}(e,t.user)}catch(t){e.innerHTML=`\n      <div class="deepsight-error">\n        <p>âŒ Error: ${t.message}</p>\n        <button class="deepsight-btn-primary" onclick="location.reload()">Retry</button>\n      </div>\n    `}}}function c(){if(n)return;if(document.getElementById("deepsight-analyze-btn"))return void(n=!0);const l=e(window.location.href);if(!l)return void console.log("[DeepSight] No video ID found in URL");o++,console.log(`[DeepSight] Injection attempt ${o}/50`);const p=function(){for(const e of d){const t=document.querySelector(e);if(t&&t instanceof HTMLElement)return console.log("[DeepSight] Found container with selector:",e),t}return null}();if(p)i=function(){const e=document.createElement("button");return e.id="deepsight-analyze-btn",e.className="deepsight-btn "+(a()?"dark":"light"),e.innerHTML='\n    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n      <circle cx="12" cy="12" r="10"/>\n      <path d="M12 6v6l4 2"/>\n    </svg>\n    <span>DeepSight</span>\n  ',e.addEventListener("click",r),e}(),p.firstChild?p.insertBefore(i,p.firstChild):p.appendChild(i),s=function(){const e=document.createElement("div");e.id="deepsight-panel",e.className="deepsight-panel "+(a()?"dark":"light"),e.innerHTML='\n    <div class="deepsight-panel-header">\n      <div class="deepsight-panel-title">\n        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n          <circle cx="12" cy="12" r="10"/>\n          <path d="M12 6v6l4 2"/>\n        </svg>\n        <span>DeepSight</span>\n      </div>\n      <button class="deepsight-panel-close" id="deepsight-close">Ã—</button>\n    </div>\n    <div class="deepsight-panel-content" id="deepsight-content">\n      <div class="deepsight-loading">\n        <div class="deepsight-spinner"></div>\n        <p>Checking authentication...</p>\n      </div>\n    </div>\n  ';const t=e.querySelector("#deepsight-close");return t?.addEventListener("click",()=>{e.classList.remove("open")}),e}(),document.body.appendChild(s),n=!0,t=l,console.log("[DeepSight] âœ… UI injected successfully for video:",l);else if(o<50){const e=Math.min(1e3*Math.pow(1.2,o),5e3);console.log(`[DeepSight] Container not found, retrying in ${e}ms...`),setTimeout(c,e)}else console.error("[DeepSight] âŒ Failed to find button container after max attempts")}function l(){const d=e(window.location.href);console.log("[DeepSight] Navigation detected, videoId:",d,"currentVideoId:",t),d!==t&&(n=!1,o=0,i?.remove(),s?.remove(),i=null,s=null,d&&setTimeout(c,1e3))}function p(){console.log("[DeepSight] Content script loaded on:",window.location.href),c();const t=history.pushState;history.pushState=function(...e){t.apply(history,e),setTimeout(l,500)},window.addEventListener("popstate",()=>{setTimeout(l,500)}),document.addEventListener("yt-navigate-finish",()=>{console.log("[DeepSight] yt-navigate-finish event detected"),setTimeout(l,500)}),document.addEventListener("yt-page-data-updated",()=>{console.log("[DeepSight] yt-page-data-updated event detected"),n||setTimeout(c,500)}),new MutationObserver(()=>{const e=a();i?.classList.toggle("dark",e),i?.classList.toggle("light",!e),s?.classList.toggle("dark",e),s?.classList.toggle("light",!e)}).observe(document.documentElement,{attributes:!0,attributeFilter:["dark","class"]}),new MutationObserver(t=>{if(!n)for(const s of t)"childList"===s.type&&s.addedNodes.length>0&&e(window.location.href)&&!n&&(clearTimeout(window.__deepsightInjectionTimeout),window.__deepsightInjectionTimeout=window.setTimeout(()=>{c()},500))}).observe(document.body,{childList:!0,subtree:!0})}chrome.runtime.onMessage.addListener(e=>{if("ANALYSIS_PROGRESS"===e.action){const t=document.getElementById("deepsight-progress-bar"),n=document.getElementById("deepsight-progress-text");t&&n&&(t.style.width=`${e.data.progress}%`,n.textContent=e.data.message)}}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",p):p()})();