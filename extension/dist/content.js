(()=>{"use strict";const e="https://www.deepsightsynthesis.com",s=[/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&?\s]+)/,/youtube\.com\/shorts\/([^&?\s]+)/];function t(e){for(const t of s){const s=e.match(t);if(s)return s[1]}return null}function n(e){const s=document.createElement("div");return s.textContent=e,s.innerHTML}function i(e){return e.replace(/`([^`]+)`/g,'<code class="ds-md-code">$1</code>').replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/\*(.+?)\*/g,"<em>$1</em>").replace(/\b(SOLIDE|SOLID)\b/g,'<span class="ds-marker ds-marker-solid">$1</span>').replace(/\b(PLAUSIBLE)\b/g,'<span class="ds-marker ds-marker-plausible">$1</span>').replace(/\b(INCERTAIN|UNCERTAIN)\b/g,'<span class="ds-marker ds-marker-uncertain">$1</span>').replace(/\b(A VERIFIER|TO VERIFY|QUESTIONABLE|WEAK)\b/g,'<span class="ds-marker ds-marker-weak">$1</span>')}function d(e){return e.replace(/\*\*(.+?)\*\*/g,"$1").replace(/\*(.+?)\*/g,"$1").replace(/`([^`]+)`/g,"$1").replace(/#{1,6}\s+/g,"").replace(/\[([^\]]+)\]\([^)]+\)/g,"$1").replace(/^>\s+/gm,"").replace(/\n+/g," ").trim()}function a(e,s){if(e.length<=s)return e;const t=e.substring(0,s),n=t.lastIndexOf(" ");return(n>.6*s?t.substring(0,n):t)+"..."}let o=null,r=!1,c=null,l=0;const u=["#secondary-inner","#secondary","ytd-watch-next-secondary-results-renderer"],m={tech:"ğŸ’»",science:"ğŸ”¬",education:"ğŸ“š",news:"ğŸ“°",entertainment:"ğŸ¬",gaming:"ğŸ®",music:"ğŸµ",sports:"âš½",business:"ğŸ’¼",lifestyle:"ğŸŒŸ",other:"ğŸ“‹"};function g(){const e=document.documentElement;return"true"===e.getAttribute("dark")||e.hasAttribute("dark")||document.body.classList.contains("dark")||getComputedStyle(document.body).backgroundColor.includes("rgb(15,")||getComputedStyle(e).getPropertyValue("--yt-spec-base-background").includes("#0f")}function p(e){return chrome.runtime.getURL(`assets/${e}`)}function h(e=48){return`\n    <div class="ds-deepsight-spinner" style="width:${e}px;height:${e}px;">\n      <img src="${p("spinner-cosmic.jpg")}" alt="" class="ds-spinner-cosmic" />\n      <img src="${p("spinner-wheel.jpg")}" alt="" class="ds-spinner-wheel" />\n    </div>`}function y(){return`\n    <div class="ds-deepsight-spinner ds-deepsight-spinner-sm">\n      <img src="${p("spinner-wheel.jpg")}" alt="" class="ds-spinner-wheel" />\n    </div>`}function v(s){s.innerHTML=`\n    <p class="ds-subtitle">Analyze this video with AI-powered insights</p>\n\n    <button class="ds-btn ds-btn-google" id="ds-google-login">\n      <svg width="18" height="18" viewBox="0 0 24 24">\n        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>\n        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>\n        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>\n        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>\n      </svg>\n      Sign in with Google\n    </button>\n\n    <div class="ds-divider"><span>or</span></div>\n\n    <form id="ds-login-form" class="ds-login-form">\n      <input type="email" id="ds-email" placeholder="Email" required />\n      <input type="password" id="ds-password" placeholder="Password" required />\n      <div id="ds-login-error" class="ds-error-msg hidden"></div>\n      <button type="submit" class="ds-btn ds-btn-primary" id="ds-login-btn">Sign In</button>\n    </form>\n\n    <div class="ds-card-footer">\n      <a href="${e}/register" target="_blank" rel="noreferrer">Create account</a>\n      <span>Â·</span>\n      <a href="${e}" target="_blank" rel="noreferrer">deepsightsynthesis.com</a>\n    </div>\n  `,document.getElementById("ds-google-login")?.addEventListener("click",async()=>{const e=document.getElementById("ds-google-login");e.disabled=!0,e.innerHTML=`${y()} Connecting...`;try{const e=await chrome.runtime.sendMessage({action:"GOOGLE_LOGIN"});if(!e.success||!e.user)throw new Error(e.error||"Google login failed");await $()}catch(s){const t=document.getElementById("ds-login-error");t&&(t.textContent=s.message,t.classList.remove("hidden")),e.disabled=!1,e.innerHTML='\n        <svg width="18" height="18" viewBox="0 0 24 24">\n          <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>\n          <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>\n          <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>\n          <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>\n        </svg>\n        Sign in with Google\n      '}}),document.getElementById("ds-login-form")?.addEventListener("submit",async e=>{e.preventDefault();const s=document.getElementById("ds-email").value,t=document.getElementById("ds-password").value,n=document.getElementById("ds-login-btn"),i=document.getElementById("ds-login-error");n.disabled=!0,n.textContent="Signing in...",i.classList.add("hidden");try{const e=await chrome.runtime.sendMessage({action:"LOGIN",data:{email:s,password:t}});if(!e.success||!e.user)throw new Error(e.error||"Login failed");await $()}catch(e){i.textContent=e.message,i.classList.remove("hidden"),n.disabled=!1,n.textContent="Sign In"}})}function f(s,t){s.innerHTML=`\n    <div class="ds-user-bar">\n      <span class="ds-user-name">${n(t.username)}</span>\n      <span class="ds-user-plan">${n(t.plan)}</span>\n      <span class="ds-user-credits">${t.credits} credits</span>\n    </div>\n\n    <button class="ds-btn ds-btn-analyze" id="ds-analyze-btn">\n      ğŸš€ Analyze this video\n    </button>\n\n    <div class="ds-options-row">\n      <select id="ds-mode" class="ds-select" title="Analysis mode">\n        <option value="standard">ğŸ“‹ Standard</option>\n        <option value="accessible">ğŸ“– Accessible</option>\n        <option value="expert">ğŸ“ Expert</option>\n      </select>\n      <select id="ds-lang" class="ds-select" title="Language">\n        <option value="fr">ğŸ‡«ğŸ‡· FR</option>\n        <option value="en">ğŸ‡¬ğŸ‡§ EN</option>\n        <option value="es">ğŸ‡ªğŸ‡¸ ES</option>\n        <option value="de">ğŸ‡©ğŸ‡ª DE</option>\n      </select>\n    </div>\n\n    <div id="ds-result" class="hidden"></div>\n\n    <div class="ds-card-footer">\n      <a href="${e}" target="_blank" rel="noreferrer">ğŸŒ deepsightsynthesis.com</a>\n      <button id="ds-logout" class="ds-link-btn">Sign out</button>\n    </div>\n  `,document.getElementById("ds-analyze-btn")?.addEventListener("click",()=>{const e=document.getElementById("ds-mode").value,s=document.getElementById("ds-lang").value;b(window.location.href,{mode:e,lang:s})}),document.getElementById("ds-logout")?.addEventListener("click",async()=>{await chrome.runtime.sendMessage({action:"LOGOUT"}),await $()})}async function b(e,s){const t=document.getElementById("ds-analyze-btn");if(t){t.disabled=!0,t.innerHTML=`${y()} Analyzing...`,function(){const e=document.getElementById("ds-result");e&&(e.classList.remove("hidden"),e.innerHTML=`\n    <div class="ds-progress">\n      <div class="ds-progress-bar" id="ds-progress-bar" style="width: 0%"></div>\n    </div>\n    <p class="ds-progress-text" id="ds-progress-text">${n("Starting analysis...")}</p>\n  `)}();try{const t=await chrome.runtime.sendMessage({action:"ANALYZE_VIDEO",data:{url:e,options:s}});if(!t.success)throw new Error(t.error);const n=t.result;if("completed"===n.status&&n.result?.summary_id)await E(n.result.summary_id);else if("failed"===n.status)throw new Error(n.error||"Analysis failed")}catch(i){const d=document.getElementById("ds-result");d&&(d.innerHTML=`\n        <div class="ds-error">\n          <p>âŒ ${n(i.message)}</p>\n          <button class="ds-btn ds-btn-secondary" id="ds-retry">Retry</button>\n        </div>\n      `,document.getElementById("ds-retry")?.addEventListener("click",()=>{b(e,s)})),t.disabled=!1,t.innerHTML="ğŸš€ Analyze this video"}}}async function E(s){const t=document.getElementById("ds-result"),o=document.getElementById("ds-analyze-btn");if(t)try{const c=await chrome.runtime.sendMessage({action:"GET_SUMMARY",data:{summaryId:s}});if(!c.success)throw new Error(c.error);const l=c.summary,u={verdict:function(e){const s=[/#+\s*(?:Conclusion|Verdict|SynthÃ¨se|RÃ©sumÃ©|Summary|En rÃ©sumÃ©|Final Assessment|Overall Assessment)[^\n]*\n([\s\S]*?)(?=\n#|\n---|\n\*{3,}|$)/i,/\*\*(?:Conclusion|Verdict|SynthÃ¨se|En rÃ©sumÃ©|Summary)\*\*[:\s]*([\s\S]*?)(?=\n\n|\n#|\n---|\n\*{3,}|$)/i];for(const t of s){const s=e.match(t);if(s&&s[1]){const e=d(s[1]).trim();if(e.length>20)return a(e,200)}}const t=e.split(/\n\n+/).filter(e=>{const s=e.trim();return s.length>30&&!s.startsWith("#")&&!s.startsWith("-")&&!s.startsWith("*")});return t.length>0?a(d(t[t.length-1]),200):"Analysis complete. See detailed view for full results."}(r=l.summary_content),keyPoints:function(e){const s=[],t=e.split("\n"),n=[/\b(?:SOLIDE|SOLID)\b/i,/\u2705\s*\*\*/,/\u2705/],i=[/\b(?:A VERIFIER|TO VERIFY|QUESTIONABLE|WEAK|INCERTAIN|UNCERTAIN)\b/i,/\u26A0\uFE0F\s*\*\*/,/\u2753/,/\u26A0/],o=[/\b(?:PLAUSIBLE)\b/i,/\uD83D\uDCA1/];for(const e of t){const t=e.replace(/^[\s\-*]+/,"").trim();if(t.length<10)continue;let r=null;if(n.some(s=>s.test(e))?r="solid":i.some(s=>s.test(e))?r="weak":o.some(s=>s.test(e))&&(r="insight"),r&&s.filter(e=>e.type===r).length<2){const e=d(t).replace(/\b(?:SOLIDE|SOLID|PLAUSIBLE|INCERTAIN|UNCERTAIN|A VERIFIER|TO VERIFY|QUESTIONABLE|WEAK)\b\s*[:â€”\-â€“]?\s*/gi,"").replace(/^[âœ…âš ï¸â“ğŸ’¡ğŸ”ğŸ”¬]\s*/u,"").trim();e.length>10&&s.push({type:r,text:a(e,120)})}if(s.length>=4)break}if(s.length<2){const t=/#+\s*(?:Points?\s+(?:forts?|clÃ©s?|faibles?)|Key\s+(?:Points?|Findings?|Takeaways?)|Strengths?|Weaknesses?|Main\s+Points?)[^\n]*\n([\s\S]*?)(?=\n#|$)/gi;let n;for(;null!==(n=t.exec(e))&&s.length<4;){const e=n[1].match(/^[\s]*[-*]\s+(.+)$/gm);if(e)for(const t of e.slice(0,4-s.length)){const e=d(t.replace(/^[\s]*[-*]\s+/,""));e.length>10&&!s.some(s=>s.text===a(e,120))&&s.push({type:"insight",text:a(e,120)})}}}return s.slice(0,4)}(r),tags:function(e){const s=[],t=e.match(/#+\s*(?:Tags?|ThÃ¨mes?|Themes?|Topics?|CatÃ©gories?|Categories?)[^\n]*\n([\s\S]*?)(?=\n#|$)/i);if(t){const e=t[1].match(/[-*]\s+(.+)/g);if(e)for(const t of e.slice(0,3)){const e=d(t.replace(/^[-*]\s+/,"")).trim();e.length>0&&e.length<30&&s.push(e)}}if(0===s.length){const t=e.match(/^#{2,3}\s+(.+)$/gm);if(t){const e=/^(?:Conclusion|Summary|RÃ©sumÃ©|SynthÃ¨se|Introduction|Verdict|Analysis|Points?\s+(?:clÃ©s?|forts?|faibles?)|Key\s+(?:Points?|Findings?)|Strengths?|Weaknesses?|Overview)/i;for(const n of t){const t=d(n.replace(/^#{2,3}\s+/,"")).trim();if(t.length>2&&t.length<35&&!e.test(t)&&(s.push(t),s.length>=3))break}}}return s.slice(0,3)}(r)},g=function(e){const s=e.split("\n"),t=[];let n=!1,d=!1;for(let e=0;e<s.length;e++){let a=s[e];if(/^-{3,}$/.test(a.trim())||/^\*{3,}$/.test(a.trim())){n&&(t.push("</ul>"),n=!1),d&&(t.push("</ol>"),d=!1),t.push('<hr class="ds-md-hr">');continue}const o=a.match(/^(#{1,4})\s+(.+)$/);if(o){n&&(t.push("</ul>"),n=!1),d&&(t.push("</ol>"),d=!1);const e=o[1].length,s=i(o[2]);t.push(`<h${e} class="ds-md-h${e}">${s}</h${e}>`);continue}if(a.startsWith("&gt; ")||"&gt;"===a){n&&(t.push("</ul>"),n=!1),d&&(t.push("</ol>"),d=!1);const e=i(a.replace(/^&gt;\s?/,""));t.push(`<blockquote class="ds-md-blockquote">${e}</blockquote>`);continue}const r=a.match(/^(\s*)[-*]\s+(.+)$/);if(r){d&&(t.push("</ol>"),d=!1),n||(t.push('<ul class="ds-md-ul">'),n=!0),t.push(`<li>${i(r[2])}</li>`);continue}const c=a.match(/^(\s*)\d+\.\s+(.+)$/);c?(n&&(t.push("</ul>"),n=!1),d||(t.push('<ol class="ds-md-ol">'),d=!0),t.push(`<li>${i(c[2])}</li>`)):(n&&(t.push("</ul>"),n=!1),d&&(t.push("</ol>"),d=!1),""!==a.trim()?t.push(`<p class="ds-md-p">${i(a)}</p>`):t.push('<div class="ds-md-spacer"></div>'))}return n&&t.push("</ul>"),d&&t.push("</ol>"),t.join("\n")}(n(l.summary_content)).replace(/\[(\d{1,2}:\d{2}(?::\d{2})?)\]/g,(e,s)=>{const t=function(e){const s=e.split(":").map(Number);return 3===s.length?3600*s[0]+60*s[1]+s[2]:60*s[0]+s[1]}(s);return`<a href="#" class="ds-timestamp" data-time="${t}">[${s}]</a>`}),p=m[l.category]||"ğŸ“‹",h=l.reliability_score>=80?"âœ…":l.reliability_score>=60?"âš ï¸":"â“",v=l.reliability_score>=80?"ds-score-high":l.reliability_score>=60?"ds-score-mid":"ds-score-low",f=u.keyPoints.length>0?u.keyPoints.map(e=>`<div class="ds-kp ds-kp-${e.type}">\n            <span class="ds-kp-icon">${function(e){switch(e){case"solid":return"âœ…";case"weak":return"âš ï¸";case"insight":return"ğŸ’¡"}}(e.type)}</span>\n            <span class="ds-kp-text">${n(e.text)}</span>\n          </div>`).join(""):"",b=u.tags.length>0?`<div class="ds-tags">${u.tags.map(e=>`<span class="ds-tag-pill">${n(e)}</span>`).join("")}</div>`:"";t.innerHTML=`\n      <div class="ds-summary ds-summary-fadein">\n        \x3c!-- Status bar --\x3e\n        <div class="ds-status-bar">\n          <span class="ds-done">âœ… Analysis Complete</span>\n          <div class="ds-status-badges">\n            <span class="ds-tag">${p} ${n(l.category)}</span>\n            <span class="ds-tag ${v}">${h} ${l.reliability_score}%</span>\n          </div>\n        </div>\n\n        \x3c!-- Verdict --\x3e\n        <div class="ds-verdict">\n          <p class="ds-verdict-text">${n(u.verdict)}</p>\n        </div>\n\n        \x3c!-- Key Points --\x3e\n        ${f?`<div class="ds-keypoints">${f}</div>`:""}\n\n        \x3c!-- Tags --\x3e\n        ${b}\n\n        \x3c!-- Toggle detailed view --\x3e\n        <button class="ds-toggle-detail" id="ds-toggle-detail">\n          <span class="ds-toggle-text">See detailed analysis</span>\n          <span class="ds-toggle-arrow">â–¼</span>\n        </button>\n\n        \x3c!-- Detailed view (hidden by default) --\x3e\n        <div class="ds-detail-panel hidden" id="ds-detail-panel">\n          <div class="ds-detail-content" id="ds-summary-text">\n            ${g}\n          </div>\n        </div>\n\n        \x3c!-- Action buttons --\x3e\n        <div class="ds-summary-actions">\n          <a href="${e}/summary/${s}" target="_blank" rel="noreferrer" class="ds-btn ds-btn-primary">\n            ğŸ“– Full analysis on DeepSight\n          </a>\n          <button class="ds-btn ds-btn-secondary" id="ds-chat-btn">\n            ğŸ’¬ Chat with video\n          </button>\n        </div>\n      </div>\n    `;const $=document.getElementById("ds-toggle-detail"),w=document.getElementById("ds-detail-panel");$?.addEventListener("click",()=>{const e=w?.classList.contains("hidden");w?.classList.toggle("hidden");const s=$.querySelector(".ds-toggle-arrow"),t=$.querySelector(".ds-toggle-text");s&&(s.textContent=e?"â–²":"â–¼"),t&&(t.textContent=e?"Hide detailed analysis":"See detailed analysis"),$.classList.toggle("ds-toggle-active",e||!1)}),t.querySelectorAll(".ds-timestamp").forEach(e=>{e.addEventListener("click",s=>{s.preventDefault(),function(e){const s=document.querySelector("video");s&&(s.currentTime=e,s.play())}(parseInt(e.dataset.time||"0"))})}),document.getElementById("ds-chat-btn")?.addEventListener("click",()=>{!function(e,s){const t=document.getElementById("ds-result");if(!t)return;const i=s.length>35?s.substring(0,35)+"...":s;t.innerHTML=`\n    <div class="ds-chat">\n      <div class="ds-chat-head">\n        <button class="ds-back" id="ds-chat-back">â† Back</button>\n        <span>Chat: "${n(i)}"</span>\n      </div>\n      <div class="ds-chat-messages" id="ds-messages">\n        <div class="ds-msg ds-msg-bot">ğŸ‘‹ Ask me anything about this video.</div>\n      </div>\n      <form class="ds-chat-form" id="ds-chat-form">\n        <input type="text" id="ds-chat-input" placeholder="Ask a question..." autocomplete="off" />\n        <button type="submit" class="ds-btn ds-btn-primary ds-btn-send">â†’</button>\n      </form>\n    </div>\n  `,document.getElementById("ds-chat-back")?.addEventListener("click",()=>{E(e)}),document.getElementById("ds-chat-form")?.addEventListener("submit",async s=>{s.preventDefault();const t=document.getElementById("ds-chat-input"),i=t.value.trim();i&&(t.value="",await async function(e,s){const t=document.getElementById("ds-messages");if(t){t.innerHTML+=`<div class="ds-msg ds-msg-user">${n(s)}</div>`,t.innerHTML+=`<div class="ds-msg ds-msg-bot ds-loading" id="ds-chat-loading">${y()}</div>`,t.scrollTop=t.scrollHeight;try{const i=await chrome.runtime.sendMessage({action:"ASK_QUESTION",data:{summaryId:e,question:s}});if(document.getElementById("ds-chat-loading")?.remove(),!i.success)throw new Error(i.error);const d=i.result,a=n(d.response).replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/\n/g,"<br>");t.innerHTML+=`\n      <div class="ds-msg ds-msg-bot">\n        ${a}\n        ${d.web_search_used?'<span class="ds-web-badge">ğŸŒ Web</span>':""}\n      </div>\n    `,t.scrollTop=t.scrollHeight}catch(e){document.getElementById("ds-chat-loading")?.remove(),t.innerHTML+=`<div class="ds-msg ds-msg-error">âŒ ${n(e.message)}</div>`}}}(e,i))})}(s,l.video_title)}),o&&(o.disabled=!1,o.innerHTML="ğŸ”„ Re-analyze")}catch(e){t.innerHTML=`\n      <div class="ds-error">\n        <p>âŒ Failed to load summary: ${n(e.message)}</p>\n      </div>\n    `,o&&(o.disabled=!1,o.innerHTML="ğŸš€ Analyze this video")}var r}async function $(){const e=document.getElementById("deepsight-card-body");if(e){e.innerHTML=`<div class="ds-loading">${h(48)}<p class="ds-loading-text">Loading...</p></div>`;try{const s=await chrome.runtime.sendMessage({action:"CHECK_AUTH"});s.authenticated&&s.user?f(e,s.user):v(e)}catch{v(e)}}}function w(){if(r)return;if(document.getElementById("deepsight-card"))return void(r=!0);const e=t(window.location.href);if(!e)return;l++;const s=function(){for(const e of u){const s=document.querySelector(e);if(s instanceof HTMLElement)return s}return null}();if(s)c=function(){const e=document.createElement("div");return e.id="deepsight-card",e.className="deepsight-card "+(g()?"dark":"light"),e.innerHTML=`\n    <div class="ds-card-header">\n      <div class="ds-card-logo">\n        ${function(e=24){return`<img src="${p("deepsight-logo-cosmic.png")}" alt="DeepSight" width="${e}" height="${e}" style="object-fit:contain;border-radius:50%;" />`}(22)}\n        <span>Deep Sight</span>\n      </div>\n      <span class="ds-card-badge">AI Analysis</span>\n    </div>\n    <div class="ds-card-body" id="deepsight-card-body">\n      <div class="ds-loading">\n        ${h(48)}\n        <p class="ds-loading-text">Loading...</p>\n      </div>\n    </div>\n  `,e}(),s.firstChild?s.insertBefore(c,s.firstChild):s.appendChild(c),r=!0,o=e,$();else if(l<50){const e=Math.min(1e3*Math.pow(1.2,l),5e3);setTimeout(w,e)}}function I(){const e=t(window.location.href);e!==o&&(r=!1,l=0,c?.remove(),c=null,e&&setTimeout(w,1e3))}function L(){w();const e=history.pushState;let s;history.pushState=function(...s){e.apply(history,s),setTimeout(I,500)},window.addEventListener("popstate",()=>setTimeout(I,500)),document.addEventListener("yt-navigate-finish",()=>setTimeout(I,500)),document.addEventListener("yt-page-data-updated",()=>{r||setTimeout(w,500)}),new MutationObserver(()=>{const e=g();c?.classList.toggle("dark",e),c?.classList.toggle("light",!e)}).observe(document.documentElement,{attributes:!0,attributeFilter:["dark","class"]}),new MutationObserver(e=>{if(!r)for(const n of e)if("childList"===n.type&&n.addedNodes.length>0&&t(window.location.href)){clearTimeout(s),s=setTimeout(w,500);break}}).observe(document.body,{childList:!0,subtree:!0})}chrome.runtime.onMessage.addListener(e=>{if("ANALYSIS_PROGRESS"===e.action&&e.data){const s=document.getElementById("ds-progress-bar"),t=document.getElementById("ds-progress-text");s&&t&&(s.style.width=`${e.data.progress}%`,t.textContent=e.data.message)}}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",L):L()})();