(()=>{"use strict";const e="https://www.deepsightsynthesis.com",t=[/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&?\s]+)/,/youtube\.com\/shorts\/([^&?\s]+)/];function s(e){for(const s of t){const t=e.match(s);if(t)return t[1]}return null}function n(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function i(e){return e.replace(/`([^`]+)`/g,'<code class="ds-md-code">$1</code>').replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/\*(.+?)\*/g,"<em>$1</em>").replace(/\b(SOLIDE|SOLID)\b/g,'<span class="ds-marker ds-marker-solid">$1</span>').replace(/\b(PLAUSIBLE)\b/g,'<span class="ds-marker ds-marker-plausible">$1</span>').replace(/\b(INCERTAIN|UNCERTAIN)\b/g,'<span class="ds-marker ds-marker-uncertain">$1</span>').replace(/\b(A VERIFIER|TO VERIFY|QUESTIONABLE|WEAK)\b/g,'<span class="ds-marker ds-marker-weak">$1</span>')}function d(e){return e.replace(/\*\*(.+?)\*\*/g,"$1").replace(/\*(.+?)\*/g,"$1").replace(/`([^`]+)`/g,"$1").replace(/#{1,6}\s+/g,"").replace(/\[([^\]]+)\]\([^)]+\)/g,"$1").replace(/^>\s+/gm,"").replace(/\n+/g," ").trim()}function a(e,t){if(e.length<=t)return e;const s=e.substring(0,t),n=s.lastIndexOf(" ");return(n>.6*t?s.substring(0,n):s)+"..."}let o=null,r=!1,c=null,l=0;const u=["#secondary-inner","#secondary","ytd-watch-next-secondary-results-renderer"],m={tech:"ğŸ’»",science:"ğŸ”¬",education:"ğŸ“š",news:"ğŸ“°",entertainment:"ğŸ¬",gaming:"ğŸ®",music:"ğŸµ",sports:"âš½",business:"ğŸ’¼",lifestyle:"ğŸŒŸ",other:"ğŸ“‹"};function g(){const e=document.documentElement;return"true"===e.getAttribute("dark")||e.hasAttribute("dark")||document.body.classList.contains("dark")||getComputedStyle(document.body).backgroundColor.includes("rgb(15,")||getComputedStyle(e).getPropertyValue("--yt-spec-base-background").includes("#0f")}function p(e){return chrome.runtime.getURL(`assets/${e}`)}function h(e=48){return`\n    <div class="ds-deepsight-spinner" style="width:${e}px;height:${e}px;">\n      <img src="${p("spinner-cosmic.jpg")}" alt="" class="ds-spinner-cosmic" />\n      <img src="${p("spinner-wheel.jpg")}" alt="" class="ds-spinner-wheel" />\n    </div>`}function y(){return`\n    <div class="ds-deepsight-spinner ds-deepsight-spinner-sm">\n      <img src="${p("spinner-wheel.jpg")}" alt="" class="ds-spinner-wheel" />\n    </div>`}function v(t){t.innerHTML=`\n    <p class="ds-subtitle">Analyze this video with AI-powered insights</p>\n\n    <button class="ds-btn ds-btn-google" id="ds-google-login">\n      <svg width="18" height="18" viewBox="0 0 24 24">\n        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>\n        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>\n        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>\n        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>\n      </svg>\n      Sign in with Google\n    </button>\n\n    <div class="ds-divider"><span>or</span></div>\n\n    <form id="ds-login-form" class="ds-login-form">\n      <input type="email" id="ds-email" placeholder="Email" required />\n      <input type="password" id="ds-password" placeholder="Password" required />\n      <div id="ds-login-error" class="ds-error-msg hidden"></div>\n      <button type="submit" class="ds-btn ds-btn-primary" id="ds-login-btn">Sign In</button>\n    </form>\n\n    <div class="ds-card-footer">\n      <a href="${e}/register" target="_blank" rel="noreferrer">Create account</a>\n      <span>Â·</span>\n      <a href="${e}" target="_blank" rel="noreferrer">deepsightsynthesis.com</a>\n    </div>\n  `,document.getElementById("ds-google-login")?.addEventListener("click",async()=>{const e=document.getElementById("ds-google-login");e.disabled=!0,e.innerHTML=`${y()} Connecting...`;try{const e=await chrome.runtime.sendMessage({action:"GOOGLE_LOGIN"});if(!e.success||!e.user)throw new Error(e.error||"Google login failed");await $()}catch(t){const s=document.getElementById("ds-login-error");s&&(s.textContent=t.message,s.classList.remove("hidden")),e.disabled=!1,e.innerHTML='<svg width="18" height="18" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg> Sign in with Google'}}),document.getElementById("ds-login-form")?.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("ds-email").value,s=document.getElementById("ds-password").value,n=document.getElementById("ds-login-btn"),i=document.getElementById("ds-login-error");n.disabled=!0,n.textContent="Signing in...",i.classList.add("hidden");try{const e=await chrome.runtime.sendMessage({action:"LOGIN",data:{email:t,password:s}});if(!e.success||!e.user)throw new Error(e.error||"Login failed");await $()}catch(e){i.textContent=e.message,i.classList.remove("hidden"),n.disabled=!1,n.textContent="Sign In"}})}function b(t,s){t.innerHTML=`\n    <div class="ds-user-bar">\n      <span class="ds-user-name">${n(s.username)}</span>\n      <span class="ds-user-plan ds-plan-${n(s.plan)}">${n(s.plan)}</span>\n      <span class="ds-user-credits">${s.credits} credits</span>\n    </div>\n\n    <button class="ds-btn ds-btn-analyze" id="ds-analyze-btn">\n      ğŸš€ Analyze this video\n    </button>\n\n    <div class="ds-options-row">\n      <select id="ds-mode" class="ds-select" title="Analysis mode">\n        <option value="standard">ğŸ“‹ Standard</option>\n        <option value="accessible">ğŸ“– Accessible</option>\n        <option value="expert">ğŸ“ Expert</option>\n      </select>\n      <select id="ds-lang" class="ds-select" title="Language">\n        <option value="fr">ğŸ‡«ğŸ‡· FR</option>\n        <option value="en">ğŸ‡¬ğŸ‡§ EN</option>\n        <option value="es">ğŸ‡ªğŸ‡¸ ES</option>\n        <option value="de">ğŸ‡©ğŸ‡ª DE</option>\n      </select>\n    </div>\n\n    <div id="ds-result" class="hidden"></div>\n\n    <div class="ds-card-footer">\n      <a href="${e}" target="_blank" rel="noreferrer">ğŸŒ deepsightsynthesis.com</a>\n      <button id="ds-logout" class="ds-link-btn">Sign out</button>\n    </div>\n  `,document.getElementById("ds-analyze-btn")?.addEventListener("click",()=>{const e=document.getElementById("ds-mode").value,t=document.getElementById("ds-lang").value;f(window.location.href,{mode:e,lang:t})}),document.getElementById("ds-logout")?.addEventListener("click",async()=>{await chrome.runtime.sendMessage({action:"LOGOUT"}),await $()})}async function f(e,t){const s=document.getElementById("ds-analyze-btn");if(s){s.disabled=!0,s.innerHTML=`${y()} Analyzing...`,function(){const e=document.getElementById("ds-result");e&&(e.classList.remove("hidden"),e.innerHTML=`\n    <div class="ds-progress">\n      <div class="ds-progress-bar" id="ds-progress-bar" style="width: 0%"></div>\n    </div>\n    <p class="ds-progress-text" id="ds-progress-text">${n("Starting analysis...")}</p>\n  `)}();try{const s=await chrome.runtime.sendMessage({action:"ANALYZE_VIDEO",data:{url:e,options:t}});if(!s.success)throw new Error(s.error);const n=s.result;if("completed"===n.status&&n.result?.summary_id)await E(n.result.summary_id);else if("failed"===n.status)throw new Error(n.error||"Analysis failed")}catch(i){const d=document.getElementById("ds-result");d&&(d.innerHTML=`\n        <div class="ds-error">\n          <p>âŒ ${n(i.message)}</p>\n          <button class="ds-btn ds-btn-secondary" id="ds-retry">Retry</button>\n        </div>\n      `,document.getElementById("ds-retry")?.addEventListener("click",()=>f(e,t))),s.disabled=!1,s.innerHTML="ğŸš€ Analyze this video"}}}async function E(t){const s=document.getElementById("ds-result"),r=document.getElementById("ds-analyze-btn");if(s)try{const l=await chrome.runtime.sendMessage({action:"GET_SUMMARY",data:{summaryId:t}});if(!l.success)throw new Error(l.error);const u=l.summary,g={verdict:function(e){const t=[/#+\s*(?:Conclusion|Verdict|SynthÃ¨se|RÃ©sumÃ©|Summary|En rÃ©sumÃ©|Final Assessment|Overall Assessment)[^\n]*\n([\s\S]*?)(?=\n#|\n---|\n\*{3,}|$)/i,/\*\*(?:Conclusion|Verdict|SynthÃ¨se|En rÃ©sumÃ©|Summary)\*\*[:\s]*([\s\S]*?)(?=\n\n|\n#|\n---|\n\*{3,}|$)/i];for(const s of t){const t=e.match(s);if(t&&t[1]){const e=d(t[1]).trim();if(e.length>20)return a(e,200)}}const s=e.split(/\n\n+/).filter(e=>{const t=e.trim();return t.length>30&&!t.startsWith("#")&&!t.startsWith("-")&&!t.startsWith("*")});return s.length>0?a(d(s[s.length-1]),200):"Analysis complete. See detailed view for full results."}(c=u.summary_content),keyPoints:function(e){const t=[],s=e.split("\n"),n=[/\b(?:SOLIDE|SOLID)\b/i,/\u2705\s*\*\*/,/\u2705/],i=[/\b(?:A VERIFIER|TO VERIFY|QUESTIONABLE|WEAK|INCERTAIN|UNCERTAIN)\b/i,/\u26A0\uFE0F\s*\*\*/,/\u2753/,/\u26A0/],o=[/\b(?:PLAUSIBLE)\b/i,/\uD83D\uDCA1/];for(const e of s){const s=e.replace(/^[\s\-*]+/,"").trim();if(s.length<10)continue;let r=null;if(n.some(t=>t.test(e))?r="solid":i.some(t=>t.test(e))?r="weak":o.some(t=>t.test(e))&&(r="insight"),r&&t.filter(e=>e.type===r).length<2){const e=d(s).replace(/\b(?:SOLIDE|SOLID|PLAUSIBLE|INCERTAIN|UNCERTAIN|A VERIFIER|TO VERIFY|QUESTIONABLE|WEAK)\b\s*[:â€”\-â€“]?\s*/gi,"").replace(/^[âœ…âš ï¸â“ğŸ’¡ğŸ”ğŸ”¬]\s*/u,"").trim();e.length>10&&t.push({type:r,text:a(e,120)})}if(t.length>=4)break}if(t.length<2){const s=/#+\s*(?:Points?\s+(?:forts?|clÃ©s?|faibles?)|Key\s+(?:Points?|Findings?|Takeaways?)|Strengths?|Weaknesses?|Main\s+Points?)[^\n]*\n([\s\S]*?)(?=\n#|$)/gi;let n;for(;null!==(n=s.exec(e))&&t.length<4;){const e=n[1].match(/^[\s]*[-*]\s+(.+)$/gm);if(e)for(const s of e.slice(0,4-t.length)){const e=d(s.replace(/^[\s]*[-*]\s+/,""));e.length>10&&!t.some(t=>t.text===a(e,120))&&t.push({type:"insight",text:a(e,120)})}}}return t.slice(0,4)}(c),tags:function(e){const t=[],s=e.match(/#+\s*(?:Tags?|ThÃ¨mes?|Themes?|Topics?|CatÃ©gories?|Categories?)[^\n]*\n([\s\S]*?)(?=\n#|$)/i);if(s){const e=s[1].match(/[-*]\s+(.+)/g);if(e)for(const s of e.slice(0,3)){const e=d(s.replace(/^[-*]\s+/,"")).trim();e.length>0&&e.length<30&&t.push(e)}}if(0===t.length){const s=e.match(/^#{2,3}\s+(.+)$/gm);if(s){const e=/^(?:Conclusion|Summary|RÃ©sumÃ©|SynthÃ¨se|Introduction|Verdict|Analysis|Points?\s+(?:clÃ©s?|forts?|faibles?)|Key\s+(?:Points?|Findings?)|Strengths?|Weaknesses?|Overview)/i;for(const n of s){const s=d(n.replace(/^#{2,3}\s+/,"")).trim();if(s.length>2&&s.length<35&&!e.test(s)&&(t.push(s),t.length>=3))break}}}return t.slice(0,3)}(c)},p=function(e){const t=e.split("\n"),s=[];let n=!1,d=!1;for(let e=0;e<t.length;e++){let a=t[e];if(/^-{3,}$/.test(a.trim())||/^\*{3,}$/.test(a.trim())){n&&(s.push("</ul>"),n=!1),d&&(s.push("</ol>"),d=!1),s.push('<hr class="ds-md-hr">');continue}const o=a.match(/^(#{1,4})\s+(.+)$/);if(o){n&&(s.push("</ul>"),n=!1),d&&(s.push("</ol>"),d=!1);const e=o[1].length,t=i(o[2]);s.push(`<h${e} class="ds-md-h${e}">${t}</h${e}>`);continue}if(a.startsWith("&gt; ")||"&gt;"===a){n&&(s.push("</ul>"),n=!1),d&&(s.push("</ol>"),d=!1);const e=i(a.replace(/^&gt;\s?/,""));s.push(`<blockquote class="ds-md-blockquote">${e}</blockquote>`);continue}const r=a.match(/^(\s*)[-*]\s+(.+)$/);if(r){d&&(s.push("</ol>"),d=!1),n||(s.push('<ul class="ds-md-ul">'),n=!0),s.push(`<li>${i(r[2])}</li>`);continue}const c=a.match(/^(\s*)\d+\.\s+(.+)$/);c?(n&&(s.push("</ul>"),n=!1),d||(s.push('<ol class="ds-md-ol">'),d=!0),s.push(`<li>${i(c[2])}</li>`)):(n&&(s.push("</ul>"),n=!1),d&&(s.push("</ol>"),d=!1),""!==a.trim()?s.push(`<p class="ds-md-p">${i(a)}</p>`):s.push('<div class="ds-md-spacer"></div>'))}return n&&s.push("</ul>"),d&&s.push("</ol>"),s.join("\n")}(n(u.summary_content)).replace(/\[(\d{1,2}:\d{2}(?::\d{2})?)\]/g,(e,t)=>{const s=function(e){const t=e.split(":").map(Number);return 3===t.length?3600*t[0]+60*t[1]+t[2]:60*t[0]+t[1]}(t);return`<a href="#" class="ds-timestamp" data-time="${s}">[${t}]</a>`}),h=m[u.category]||"ğŸ“‹",v=u.reliability_score>=80?"âœ…":u.reliability_score>=60?"âš ï¸":"â“",b=u.reliability_score>=80?"ds-score-high":u.reliability_score>=60?"ds-score-mid":"ds-score-low",f=g.keyPoints.length>0?g.keyPoints.map(e=>`<div class="ds-kp ds-kp-${e.type}">\n            <span class="ds-kp-icon">${function(e){switch(e){case"solid":return"âœ…";case"weak":return"âš ï¸";case"insight":return"ğŸ’¡"}}(e.type)}</span>\n            <span class="ds-kp-text">${n(e.text)}</span>\n          </div>`).join(""):"",$=g.tags.length>0?`<div class="ds-tags">${g.tags.map(e=>`<span class="ds-tag-pill">${n(e)}</span>`).join("")}</div>`:"";s.innerHTML=`\n      <div class="ds-summary ds-summary-fadein">\n        <div class="ds-status-bar">\n          <span class="ds-done">âœ… Analysis Complete</span>\n          <div class="ds-status-badges">\n            <span class="ds-tag">${h} ${n(u.category)}</span>\n            <span class="ds-tag ${b}">${v} ${u.reliability_score}%</span>\n          </div>\n        </div>\n        <div class="ds-verdict"><p class="ds-verdict-text">${n(g.verdict)}</p></div>\n        ${f?`<div class="ds-keypoints">${f}</div>`:""}\n        ${$}\n        <button class="ds-toggle-detail" id="ds-toggle-detail">\n          <span class="ds-toggle-text">See detailed analysis</span>\n          <span class="ds-toggle-arrow">â–¼</span>\n        </button>\n        <div class="ds-detail-panel hidden" id="ds-detail-panel">\n          <div class="ds-detail-content" id="ds-summary-text">${p}</div>\n        </div>\n        <div class="ds-share-actions">\n          <button class="ds-btn ds-btn-outline" id="ds-copy-btn">\n            ğŸ“‹ Copy\n          </button>\n          <button class="ds-btn ds-btn-outline" id="ds-share-btn">\n            ğŸ”— Share\n          </button>\n        </div>\n        <div class="ds-summary-actions">\n          <a href="${e}/summary/${t}" target="_blank" rel="noreferrer" class="ds-btn ds-btn-primary">\n            ğŸ“– Full analysis on DeepSight\n          </a>\n          <button class="ds-btn ds-btn-secondary" id="ds-chat-btn">\n            ğŸ’¬ Chat with video\n          </button>\n        </div>\n      </div>\n    `;const w=document.getElementById("ds-toggle-detail"),I=document.getElementById("ds-detail-panel");w?.addEventListener("click",()=>{const e=I?.classList.contains("hidden");I?.classList.toggle("hidden");const t=w.querySelector(".ds-toggle-arrow"),s=w.querySelector(".ds-toggle-text");t&&(t.textContent=e?"â–²":"â–¼"),s&&(s.textContent=e?"Hide detailed analysis":"See detailed analysis"),w.classList.toggle("ds-toggle-active",e||!1)}),s.querySelectorAll(".ds-timestamp").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),function(e){const t=document.querySelector("video");t&&(t.currentTime=e,t.play())}(parseInt(e.dataset.time||"0"))})}),document.getElementById("ds-chat-btn")?.addEventListener("click",()=>function(e,t){const s=document.getElementById("ds-result");if(!s)return;const i=t.length>35?t.substring(0,35)+"...":t;s.innerHTML=`\n    <div class="ds-chat">\n      <div class="ds-chat-head">\n        <button class="ds-back" id="ds-chat-back">â† Back</button>\n        <span>Chat: â€œ${n(i)}â€</span>\n      </div>\n      <div class="ds-chat-messages" id="ds-messages">\n        <div class="ds-msg ds-msg-bot">ğŸ‘‹ Ask me anything about this video.</div>\n      </div>\n      <form class="ds-chat-form" id="ds-chat-form">\n        <input type="text" id="ds-chat-input" placeholder="Ask a question..." autocomplete="off" />\n        <button type="submit" class="ds-btn ds-btn-primary ds-btn-send">â†’</button>\n      </form>\n    </div>\n  `,document.getElementById("ds-chat-back")?.addEventListener("click",()=>E(e)),document.getElementById("ds-chat-form")?.addEventListener("submit",async t=>{t.preventDefault();const s=document.getElementById("ds-chat-input"),i=s.value.trim();i&&(s.value="",await async function(e,t){const s=document.getElementById("ds-messages");if(s){s.innerHTML+=`<div class="ds-msg ds-msg-user">${n(t)}</div>`,s.innerHTML+=`<div class="ds-msg ds-msg-bot ds-loading" id="ds-chat-loading">${y()}</div>`,s.scrollTop=s.scrollHeight;try{const i=await chrome.runtime.sendMessage({action:"ASK_QUESTION",data:{summaryId:e,question:t}});if(document.getElementById("ds-chat-loading")?.remove(),!i.success)throw new Error(i.error);const d=i.result,a=n(d.response).replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/\n/g,"<br>");s.innerHTML+=`\n      <div class="ds-msg ds-msg-bot">\n        ${a}\n        ${d.web_search_used?'<span class="ds-web-badge">ğŸŒ Web</span>':""}\n      </div>\n    `,s.scrollTop=s.scrollHeight}catch(e){document.getElementById("ds-chat-loading")?.remove(),s.innerHTML+=`<div class="ds-msg ds-msg-error">âŒ ${n(e.message)}</div>`}}}(e,i))})}(t,u.video_title)),document.getElementById("ds-copy-btn")?.addEventListener("click",async()=>{const s=document.getElementById("ds-copy-btn");if(!s)return;const n=g.keyPoints.map(e=>`- ${e.text}`).join("\n"),i=o||"";let d=`${e}/summary/${t}`;try{const e=await chrome.runtime.sendMessage({action:"SHARE_ANALYSIS",data:{videoId:i}});e.success&&e.share_url&&(d=e.share_url)}catch{}const a=["ğŸ¯ DeepSight â€” AI Analysis","",`ğŸ“¹ ${u.video_title}`,`ğŸ·ï¸ Category: ${u.category}`,`ğŸ“Š Reliability: ${u.reliability_score}%`,"",`ğŸ’¡ ${g.verdict}`,"",n?`Key points:\n${n}`:"","",`ğŸ”— ${d}`,"â€”","deepsightsynthesis.com"].filter(Boolean).join("\n");try{await navigator.clipboard.writeText(a),s.textContent="âœ… Copied!",setTimeout(()=>{s.textContent="ğŸ“‹ Copy"},2e3)}catch{s.textContent="âŒ Failed",setTimeout(()=>{s.textContent="ğŸ“‹ Copy"},2e3)}}),document.getElementById("ds-share-btn")?.addEventListener("click",async()=>{const e=document.getElementById("ds-share-btn");if(!e)return;const t=o||"";e.textContent="â³ Loading...";try{const s=await chrome.runtime.sendMessage({action:"SHARE_ANALYSIS",data:{videoId:t}});if(!s.success)throw new Error(s.error);await navigator.clipboard.writeText(s.share_url),e.textContent="âœ… Link copied!",setTimeout(()=>{e.textContent="ğŸ”— Share"},2e3)}catch{e.textContent="âŒ Failed",setTimeout(()=>{e.textContent="ğŸ”— Share"},2e3)}}),r&&(r.disabled=!1,r.innerHTML="ğŸ”„ Re-analyze")}catch(e){s.innerHTML=`<div class="ds-error"><p>âŒ Failed to load summary: ${n(e.message)}</p></div>`,r&&(r.disabled=!1,r.innerHTML="ğŸš€ Analyze this video")}var c}async function $(){const e=document.getElementById("deepsight-card-body");if(e){e.innerHTML=`<div class="ds-loading">${h(48)}<p class="ds-loading-text">Loading...</p></div>`;try{const t=await chrome.runtime.sendMessage({action:"CHECK_AUTH"});t.authenticated&&t.user?b(e,t.user):v(e)}catch{v(e)}}}function w(){if(r)return;if(document.getElementById("deepsight-card"))return void(r=!0);const e=s(window.location.href);if(!e)return;l++;const t=function(){for(const e of u){const t=document.querySelector(e);if(t instanceof HTMLElement)return t}return null}();if(t)c=function(){const e=document.createElement("div");return e.id="deepsight-card",e.className="deepsight-card "+(g()?"dark":"light"),e.innerHTML=`\n    <div class="ds-card-header">\n      <div class="ds-card-logo">\n        ${function(e=24){return`<img src="${p("deepsight-logo-cosmic.png")}" alt="DeepSight" width="${e}" height="${e}" style="object-fit:contain;border-radius:50%;" />`}(22)}\n        <span>Deep Sight</span>\n      </div>\n      <span class="ds-card-badge">AI Analysis</span>\n    </div>\n    <div class="ds-card-body" id="deepsight-card-body">\n      <div class="ds-loading">\n        ${h(48)}\n        <p class="ds-loading-text">Loading...</p>\n      </div>\n    </div>\n  `,e}(),t.firstChild?t.insertBefore(c,t.firstChild):t.appendChild(c),r=!0,o=e,$();else if(l<50){const e=Math.min(1e3*Math.pow(1.2,l),5e3);setTimeout(w,e)}}function I(){const e=s(window.location.href);e!==o&&(r=!1,l=0,c?.remove(),c=null,e&&setTimeout(w,1e3))}function L(){w();const e=history.pushState;let t;history.pushState=function(...t){e.apply(history,t),setTimeout(I,500)},window.addEventListener("popstate",()=>setTimeout(I,500)),document.addEventListener("yt-navigate-finish",()=>setTimeout(I,500)),document.addEventListener("yt-page-data-updated",()=>{r||setTimeout(w,500)}),new MutationObserver(()=>{const e=g();c?.classList.toggle("dark",e),c?.classList.toggle("light",!e)}).observe(document.documentElement,{attributes:!0,attributeFilter:["dark","class"]}),new MutationObserver(e=>{if(!r)for(const n of e)if("childList"===n.type&&n.addedNodes.length>0&&s(window.location.href)){clearTimeout(t),t=setTimeout(w,500);break}}).observe(document.body,{childList:!0,subtree:!0})}chrome.runtime.onMessage.addListener(e=>{if("ANALYSIS_PROGRESS"===e.action&&e.data){const t=document.getElementById("ds-progress-bar"),s=document.getElementById("ds-progress-text");t&&s&&(t.style.width=`${e.data.progress}%`,s.textContent=e.data.message)}}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",L):L()})();