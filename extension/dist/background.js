(()=>{"use strict";const e="https://deep-sight-backend-v3-production.up.railway.app/api";async function t(){const e=await chrome.storage.local.get(["accessToken","refreshToken"]);return{accessToken:e.accessToken||null,refreshToken:e.refreshToken||null}}async function s(e,t){await chrome.storage.local.set({accessToken:e,refreshToken:t})}async function a(){await chrome.storage.local.remove(["accessToken","refreshToken","user"])}async function r(){return(await chrome.storage.local.get(["user"])).user||null}async function n(e){await chrome.storage.local.set({user:e})}const c=[/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&?\s]+)/,/youtube\.com\/shorts\/([^&?\s]+)/];async function o(s,r={}){const{accessToken:n}=await t(),c={"Content-Type":"application/json",...r.headers};n&&(c.Authorization=`Bearer ${n}`);const o=await fetch(`${e}${s}`,{...r,headers:c});if(401===o.status){if(await i()){const{accessToken:a}=await t();c.Authorization=`Bearer ${a}`;const n=await fetch(`${e}${s}`,{...r,headers:c});if(!n.ok)throw new Error(`API Error: ${n.status}`);return n.json()}throw await a(),new Error("SESSION_EXPIRED")}if(!o.ok){const e=await o.json().catch(()=>({detail:"Unknown error"}));throw new Error(e.detail||`API Error: ${o.status}`)}return o.json()}async function i(){const{refreshToken:a}=await t();if(!a)return!1;try{const t=await fetch(`${e}/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:a})});if(!t.ok)return!1;const r=await t.json();return await s(r.access_token,r.refresh_token),await n(r.user),!0}catch{return!1}}async function u(e,t={}){return o("/videos/analyze",{method:"POST",body:JSON.stringify({url:e,mode:t.mode||"standard",lang:t.lang||"fr",category:t.category||"auto",model:t.model,force_refresh:t.force_refresh||!1})})}async function d(e){return o(`/videos/status/${e}`)}async function h(){const{accessToken:e}=await t();return!!e}async function m(t){switch(t.action){case"CHECK_AUTH":if(await h())try{return{authenticated:!0,user:await r()??void 0}}catch{return{authenticated:!1}}return{authenticated:!1};case"GET_USER":try{return{success:!0,user:await async function(){const e=await o("/auth/me");return await n(e),e}()}}catch(e){return{success:!1,error:e.message}}case"LOGIN":{const{email:a,password:r}=t.data;try{const t=await async function(t,a){const r=await fetch(`${e}/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,password:a})});if(!r.ok){const e=await r.json().catch(()=>({detail:"Login failed"}));throw new Error(e.detail||"Login failed")}const c=await r.json();return await s(c.access_token,c.refresh_token),await n(c.user),c.user}(a,r);return{success:!0,user:t}}catch(e){return{success:!1,error:e.message}}}case"GOOGLE_LOGIN":try{return{success:!0,user:await async function(){throw new Error("Google OAuth not configured. Use email/password login.")}()}}catch(e){return{success:!1,error:e.message}}case"START_ANALYSIS":{const{url:e,options:s}=t.data;try{const{task_id:t}=await u(e,s);return{success:!0,result:{task_id:t}}}catch(e){return{success:!1,error:e.message}}}case"ANALYZE_VIDEO":{const{url:e,options:s}=t.data;try{const{task_id:t}=await u(e,s),a=await async function(e){const t=Date.now();let s=2e3;for(;Date.now()-t<18e5;){const a=await d(e);if("completed"===a.status||"failed"===a.status)return a;chrome.tabs.query({active:!0,currentWindow:!0},t=>{t[0]?.id&&chrome.tabs.sendMessage(t[0].id,{action:"ANALYSIS_PROGRESS",data:{taskId:e,progress:a.progress,message:a.message}}).catch(()=>{})});const r=Date.now()-t;r>3e5?s=8e3:r>12e4?s=5e3:r>3e4&&(s=3e3),await new Promise(e=>setTimeout(e,s))}throw new Error("Analysis timeout â€” video may be too long")}(t);if("completed"===a.status&&a.result?.summary_id){const t=function(e){for(const t of c){const s=e.match(t);if(s)return s[1]}return null}(e);t&&await async function(e){const t=(await async function(){return(await chrome.storage.local.get(["recentAnalyses"])).recentAnalyses||[]}()).filter(t=>t.videoId!==e.videoId);t.unshift({...e,timestamp:Date.now()}),await chrome.storage.local.set({recentAnalyses:t.slice(0,20)})}({videoId:t,summaryId:a.result.summary_id,title:a.result.video_title||"Unknown"})}return{success:!0,result:a}}catch(e){return{success:!1,error:e.message}}}case"GET_TASK_STATUS":{const{taskId:e}=t.data;try{return{success:!0,status:await d(e)}}catch(e){return{success:!1,error:e.message}}}case"GET_SUMMARY":{const{summaryId:e}=t.data;try{const t=await async function(e){return o(`/videos/summary/${e}`)}(e);return{success:!0,summary:t}}catch(e){return{success:!1,error:e.message}}}case"ASK_QUESTION":{const{summaryId:e,question:s,options:a}=t.data;try{const t=await async function(e,t,s={}){return o("/chat/ask",{method:"POST",body:JSON.stringify({question:t,summary_id:e,mode:s.mode||"standard",use_web_search:s.use_web_search||!1})})}(e,s,a);return{success:!0,result:t}}catch(e){return{success:!1,error:e.message}}}case"GET_CHAT_HISTORY":{const{summaryId:e}=t.data;try{const t=await async function(e){try{return(await o(`/chat/${e}/history`)).messages||[]}catch{return[]}}(e);return{success:!0,result:t}}catch(e){return{success:!1,error:e.message}}}case"LOGOUT":return await async function(){try{await o("/auth/logout",{method:"POST"})}catch{}await a()}(),{success:!0};case"OPEN_POPUP":return chrome.action.setBadgeText({text:"!"}),chrome.action.setBadgeBackgroundColor({color:"#6366f1"}),{success:!0};case"SYNC_AUTH_FROM_WEBSITE":{const{accessToken:e,refreshToken:a,user:r}=t.data;try{return await s(e,a),await n(r),chrome.action.setBadgeText({text:""}),{success:!0}}catch(e){return{success:!1,error:e.message}}}default:return{error:"Unknown action"}}}chrome.runtime.onMessage.addListener((e,t,s)=>(m(e).then(s).catch(e=>s({error:e.message})),!0)),chrome.runtime.onInstalled.addListener(e=>{"install"===e.reason&&chrome.tabs.create({url:"https://www.deepsightsynthesis.com/extension-welcome"})}),chrome.alarms.create("keepAlive",{periodInMinutes:.5}),chrome.alarms.create("refreshToken",{periodInMinutes:14}),chrome.alarms.onAlarm.addListener(async e=>{"refreshToken"===e.name&&await h()&&await i()}),chrome.storage.onChanged.addListener((e,t)=>{"local"===t&&e.accessToken&&(e.accessToken.newValue?chrome.action.setBadgeText({text:""}):(chrome.action.setBadgeText({text:"!"}),chrome.action.setBadgeBackgroundColor({color:"#ef4444"})))})})();