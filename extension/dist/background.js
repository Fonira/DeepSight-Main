(()=>{"use strict";var e={661(e,t,r){r.d(t,{Be:()=>w,HW:()=>l,J1:()=>d,Q9:()=>y,Ti:()=>c,askQuestion:()=>g,g$:()=>f,q$:()=>m,ri:()=>h,setStoredTokens:()=>o,setStoredUser:()=>i});const s="https://deepsight-production.up.railway.app/api";async function a(){const e=await chrome.storage.local.get(["accessToken","refreshToken"]);return{accessToken:e.accessToken||null,refreshToken:e.refreshToken||null}}async function o(e,t){await chrome.storage.local.set({accessToken:e,refreshToken:t})}async function n(){await chrome.storage.local.remove(["accessToken","refreshToken","user"])}async function c(){return(await chrome.storage.local.get(["user"])).user||null}async function i(e){await chrome.storage.local.set({user:e})}async function u(e,t={}){const{accessToken:r}=await a(),o={"Content-Type":"application/json",...t.headers};r&&(o.Authorization=`Bearer ${r}`);const c=await fetch(`${s}${e}`,{...t,headers:o});if(401===c.status){if(await d()){const{accessToken:r}=await a();o.Authorization=`Bearer ${r}`;const n=await fetch(`${s}${e}`,{...t,headers:o});if(!n.ok)throw new Error(`API Error: ${n.status}`);return n.json()}throw await n(),new Error("SESSION_EXPIRED")}if(!c.ok){const e=await c.json().catch(()=>({detail:"Unknown error"}));throw new Error(e.detail||`API Error: ${c.status}`)}return c.json()}async function d(){const{refreshToken:e}=await a();if(!e)return!1;try{const t=await fetch(`${s}/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:e})});if(!t.ok)return!1;const r=await t.json();return await o(r.access_token,r.refresh_token),await i(r.user),!0}catch{return!1}}async function h(){try{await u("/auth/logout",{method:"POST"})}catch{}await n()}async function l(){const e=await u("/auth/me");return await i(e),e}async function m(e,t={}){return u("/videos/analyze",{method:"POST",body:JSON.stringify({url:e,mode:t.mode||"standard",lang:t.lang||"fr",category:t.category||"auto",model:t.model,force_refresh:t.force_refresh||!1})})}async function f(e){return u(`/videos/status/${e}`)}async function w(e){return u(`/videos/summary/${e}`)}async function g(e,t,r={}){return u(`/chat/${e}`,{method:"POST",body:JSON.stringify({question:t,mode:r.mode||"standard",use_web_search:r.use_web_search||!1})})}function y(e){const t=[/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&?\s]+)/,/youtube\.com\/shorts\/([^&?\s]+)/];for(const r of t){const t=e.match(r);if(t)return t[1]}return null}}},t={};function r(s){var a=t[s];if(void 0!==a)return a.exports;var o=t[s]={exports:{}};return e[s](o,o.exports,r),o.exports}r.d=(e,t)=>{for(var s in t)r.o(t,s)&&!r.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var s=r(661);async function a(e){return(await chrome.storage.local.get([e]))[e]??null}async function o(){return!!await a("accessToken")}chrome.runtime.onInstalled.addListener(e=>{console.log("[DeepSight] Extension installed:",e.reason),"install"===e.reason&&chrome.tabs.create({url:"https://deepsight.vercel.app/extension-welcome"})}),chrome.runtime.onMessage.addListener((e,t,n)=>(console.log("[DeepSight] Message received:",e.action),async function(e){switch(e.action){case"CHECK_AUTH":if(await o())try{return{authenticated:!0,user:await(0,s.Ti)()}}catch{return{authenticated:!1}}return{authenticated:!1};case"GET_USER":try{return{success:!0,user:await(0,s.HW)()}}catch(e){return{success:!1,error:e.message}}case"ANALYZE_VIDEO":{const{url:t,options:r}=e.data;try{const e=await(0,s.q$)(t,r),o=await async function(e,t=60){for(let r=0;r<t;r++){const t=await(0,s.g$)(e);if("completed"===t.status||"failed"===t.status)return t;chrome.tabs.query({active:!0,currentWindow:!0},r=>{r[0]?.id&&chrome.tabs.sendMessage(r[0].id,{action:"ANALYSIS_PROGRESS",data:{taskId:e,progress:t.progress,message:t.message}}).catch(()=>{})}),await new Promise(e=>setTimeout(e,2e3))}throw new Error("Analysis timeout")}(e.task_id);if("completed"===o.status&&o.result?.summary_id){const e=(0,s.Q9)(t);e&&await async function(e){const t=(await a("recentAnalyses")||[]).filter(t=>t.videoId!==e.videoId);t.unshift({...e,timestamp:Date.now()}),await async function(e,t){await chrome.storage.local.set({[e]:t})}("recentAnalyses",t.slice(0,20))}({videoId:e,summaryId:o.result.summary_id,title:o.result.video_title||"Unknown"})}return{success:!0,result:o}}catch(e){return{success:!1,error:e.message}}}case"GET_TASK_STATUS":{const{taskId:t}=e.data;try{return{success:!0,status:await(0,s.g$)(t)}}catch(e){return{success:!1,error:e.message}}}case"GET_SUMMARY":{const{summaryId:t}=e.data;try{return{success:!0,summary:await(0,s.Be)(t)}}catch(e){return{success:!1,error:e.message}}}case"LOGOUT":return await(0,s.ri)(),{success:!0};case"OPEN_POPUP":return chrome.action.setBadgeText({text:"!"}),chrome.action.setBadgeBackgroundColor({color:"#6366f1"}),{success:!0};case"SYNC_AUTH_FROM_WEBSITE":{const{accessToken:t,refreshToken:s,user:a}=e.data;try{const{setStoredTokens:e,setStoredUser:o}=await Promise.resolve().then(r.bind(r,661));return await e(t,s),await o(a),chrome.action.setBadgeText({text:""}),console.log("[DeepSight] Auth synced from website for user:",a.username),{success:!0}}catch(e){return console.error("[DeepSight] Failed to sync auth:",e),{success:!1,error:e.message}}}case"ASK_QUESTION":{const{summaryId:t,question:s}=e.data;try{const{askQuestion:e}=await Promise.resolve().then(r.bind(r,661));return{success:!0,result:await e(t,s)}}catch(e){return{success:!1,error:e.message}}}default:return{error:"Unknown action"}}}(e).then(n).catch(e=>{console.error("[DeepSight] Error handling message:",e),n({error:e.message})}),!0)),chrome.alarms.create("keepAlive",{periodInMinutes:.5}),chrome.alarms.onAlarm.addListener(e=>{"keepAlive"===e.name&&console.log("[DeepSight] Keep alive ping")}),chrome.alarms.create("refreshToken",{periodInMinutes:15}),chrome.alarms.onAlarm.addListener(async e=>{if("refreshToken"===e.name&&await o()){const e=await(0,s.J1)();console.log("[DeepSight] Token refresh:",e?"success":"failed")}}),chrome.storage.onChanged.addListener((e,t)=>{"local"===t&&e.accessToken&&(e.accessToken.newValue?chrome.action.setBadgeText({text:""}):(chrome.action.setBadgeText({text:"!"}),chrome.action.setBadgeBackgroundColor({color:"#ef4444"})))})})();